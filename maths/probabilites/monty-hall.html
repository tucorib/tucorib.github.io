<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="fr" lang="fr" dir="ltr">

	<head>
		<meta charset="UTF-8">
		
		<!-- Page title -->
		<title>Probabilités - Monty Hall</title>
		<!-- Smartphone screen dimension management -->
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		
		<!-- Libraries -->
		<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
		<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>
		<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
		<script src="https://code.highcharts.com/highcharts.js"></script>
		
		<!-- Images -->
		<link rel="preload" href="img/door-closed.png" as="image">
		<link rel="preload" href="img/door-opened-goat.png" as="image">
		<link rel="preload" href="img/door-opened-car.png" as="image">
		
		<script>
			// Session
			var session = null;
			// Step
			var step = null;
			// Selected door
			var selectedDoor = null;
			// Correct door
			var correctDoor = null;
			// Wrong door
			var wrongDoor = null;
			// Simulation index
			var simulationIndex = 0;
			
			// Auto-simulation
			var autoRun = false;
			// Auto-simulation spped (actions per seconds)
			var autoSimulationSpeed = 1000;
			// Auto-simulation run count
			var autoSimulationNb = 1000;
			
			// Charts
			var keepChart = null;
			var changeChart = null;
			
			var decimalPlaces = 4;
			
			function displayResults(){
				$('#keep-won').text(session.keep.won);
				$('#keep-nb').text(session.keep.nb);
				$('#keep-freq').text(session.keep.freq);				
				$('#change-won').text(session.change.won);
				$('#change-nb').text(session.change.nb);
				$('#change-freq').text(session.change.freq);
				
				if(!autoRun || simulationIndex == 2*autoSimulationNb-1 || (simulationIndex+1) % (2*autoSimulationNb/10) == 0){
					keepChart.redraw();
					changeChart.redraw();
				}			
			}
			
			function startSession(){
				// Init session
				session = {
					keep: {
						won: 0,
						nb: 0,
						freq: 0
					},
					change: {
						won: 0,
						nb: 0,
						freq: 0
					},
				};
				simulationIndex = 0;
				keepChart.series[0].setData([]);
				changeChart.series[0].setData([]);
				displayResults();
				startRun();
			}
			
			function startRun(){
				// Init step
				step = 0;
				// Init correct door
				correctDoor = Math.ceil(Math.random() * 3);
				wrongDoor = null;
				
				// Update UI
				if(!autoRun){
					// Update rules
					$('#rules').carousel(0);
					// Activate buttons
					$('#btn-door-1').attr('disabled', false).removeClass('btn-info btn-danger btn-success').addClass('btn-secondary');
					$('#btn-door-2').attr('disabled', false).removeClass('btn-info btn-danger btn-success').addClass('btn-secondary');
					$('#btn-door-3').attr('disabled', false).removeClass('btn-info btn-danger btn-success').addClass('btn-secondary');
					// Reset doors
					$('#img-door-1').attr('src', 'img/door-closed.png');
					$('#img-door-2').attr('src', 'img/door-closed.png');
					$('#img-door-3').attr('src', 'img/door-closed.png');
				}
				
				if(autoRun){
					setTimeout(function(){
						var choice = Math.ceil(Math.random() * 3);
						handleStep0Choice(Math.ceil(Math.random() * 3));
					}, 1000 / autoSimulationSpeed);
				}
			}
			
			function selectDoor(doorIndex){
				if(step == 0){
					handleStep0Choice(doorIndex);
				}
				else if(step == 1){
					handleStep1Choice(doorIndex);
				}
			}
			
			function handleStep0Choice(doorIndex){
				// Select door
				selectedDoor = doorIndex;
				
				// Mark wrong door
				var otherDoors = [1,2,3].filter(door => door != doorIndex && door != correctDoor);
				wrongDoor = otherDoors[Math.floor(Math.random() * otherDoors.length)];
				
				// Update UI
				if(!autoRun){
					$('#btn-door-' + selectedDoor)
					.removeClass('btn-secondary')
					.addClass('btn-info');
					
					$('#btn-door-' + wrongDoor)
					.attr('disabled', true)
					.removeClass('btn-secondary')
					.addClass('btn-danger');
					
					// Open wrong door
					$('#img-door-' + wrongDoor).attr('src', 'img/door-opened-goat.png');
					
					// Update rules
					$('#step-1-selected-door').text(selectedDoor);
					$('#step-1-wrong-door').text(wrongDoor);
					$('#rules').carousel('next');
				}
				
				// Next step
				step = 1;
				
				if(autoRun){
					setTimeout(function(){
						var choice = null;
						if(simulationIndex % 2 == 0){
							choice = selectedDoor;
						}
						else{
							choice = [1,2,3].filter(door => door != selectedDoor && door != wrongDoor)[0];
						}
						handleStep1Choice(choice);
					}, 1000 / autoSimulationSpeed);
				}
			};
			
			function handleStep1Choice(doorIndex){
				// Update session & rules
				if(doorIndex == selectedDoor){
					session.keep.nb += 1;
					if(doorIndex == correctDoor){
						session.keep.won += 1;
					}
					session.keep.freq = Math.round(Math.pow(10,decimalPlaces) * session.keep.won / session.keep.nb)/Math.pow(10,decimalPlaces);
					keepChart.series[0].addPoint([session.keep.nb, session.keep.freq], false, false);
				}
				else{
					session.change.nb += 1;
					if(doorIndex == correctDoor){
						session.change.won += 1;
					}
					session.change.freq = Math.round(Math.pow(10,decimalPlaces) * session.change.won / session.change.nb)/Math.pow(10,decimalPlaces);
					changeChart.series[0].addPoint([session.change.nb, session.change.freq], false, false);
				}
				
				// Update UI
				if(!autoRun){
					$('#btn-door-' + selectedDoor)
					.removeClass('btn-info');
					
					if(doorIndex == correctDoor)
						$('#btn-door-' + doorIndex)
						.removeClass('btn-secondary')
						.addClass('btn-success');
					else{
						$('#btn-door-' + doorIndex)
						.removeClass('btn-secondary')
						.addClass('btn-info');
						$('#btn-door-' + correctDoor)
						.removeClass('btn-secondary')
						.addClass('btn-success');
					}
					$('#btn-door-1').attr('disabled', true);
					$('#btn-door-2').attr('disabled', true);
					$('#btn-door-3').attr('disabled', true);
					
					
					if(doorIndex == correctDoor){
						$('#step-2-label').text('Vous avez gagné!');
					}
					else{
						$('#step-2-label').text('Vous avez perdu...');
					}
					
					$('#rules').carousel('next');
					
					// Show doors
					$('#img-door-' + correctDoor).attr('src', 'img/door-opened-car.png');
					if(doorIndex != correctDoor)
						$('#img-door-' + selectedDoor).attr('src', 'img/door-opened-goat.png');
				}
				
				simulationIndex += 1;
				displayResults();
				
				if(autoRun){
					if(simulationIndex < 2*autoSimulationNb-1){
						setTimeout(function(){
							startRun();
						}, 1000 / autoSimulationSpeed);
					}
					else{
						$('#btn-auto').button('toggle');
					}
				}
			};
			
			$(document).ready(function(){
				// Init sliders
				$("#auto-count")
				.on('input', function(slideEvt) {
					var value = parseInt($(slideEvt.target).val());
					autoSimulationNb = value;
					$("#auto-count-value").text(value);
				})
				.val(autoSimulationNb)
				.trigger('input');
				// Init toggle styles
				$('#btn-auto').click(function(event){
					autoRun = !autoRun;
					if(autoRun){
						$(this).removeClass('btn-success').addClass('btn-danger').text('Stop');
						startSession();
						$("html, body").animate( { scrollTop: $('#results').offset().top }, 1500);
					}
					else{
						$(this).removeClass('btn-danger').addClass('btn-success').text('Lancer');
					}
				});
				
				// Init charts
				keepChart = Highcharts.chart('keep-chart', {
					chart: {
				        zoomType: 'x'
				    },
				    title: null,
		            xAxis: {
		            	title: {
		            		text: "Nombre d'essais"
		            	},
		            	type: 'linear'
		            },
		            yAxis: {
		            	title: {
		            		text: "Fréquence"
		            	},
		            	type: 'linear',
		            	min: 0,
		            	max: 1,
		            },
		            legend: {
      					enabled: false,
      				},
                    series: [{
			            name: null,
			            data: []
			        }]
		        });
		        changeChart = Highcharts.chart('change-chart', {
					chart: {
				        zoomType: 'x'
				    },
				    title: null,
		            xAxis: {
		            	title: {
		            		text: "Nombre d'essais"
		            	},
		            	type: 'linear'
		            },
		            yAxis: {
		            	title: null,
		            	type: 'linear',
		            	min: 0,
		            	max: 1,
		            },
                    legend: {
      					enabled: false,
      				},
      				series: [{
			            name: 'Fréquence',
			            data: []
			        }]
		        });
        
				startSession();
			});
		</script>
	</head>
	<body>
		<img src="img/door-closed.png" style="display: none"/>
		<img src="img/door-opened-goat.png" style="display: none"/>
		<img src="img/door-opened-car.png" style="display: none"/>
		
		<!-- Game -->
		<h4 class="text-center">Jeu du Monty Hall</h4>
		<div class="container">
			<ul id="tab-list" class="nav nav-pills nav-fill" role="tablist">
			  	<li class="nav-item">
			    	<a id="manual-tab" class="nav-link active" href="#manual" data-toggle="tab" role="tab" aria-controls="manual" aria-selected="true">Simulation manuelle</a>
			  	</li>
			  	<li class="nav-item">
			    	<a id="auto-tab" class="nav-link" href="#auto" data-toggle="tab" role="tab" aria-controls="auto" aria-selected="false">Simulation automatique</a>
			  	</li>
			</ul>
			<div id="tab-content" class="tab-content">
			  	<div class="tab-pane fade show active" id="manual" role="tabpanel" aria-labelledby="manual-tab">
			  		<!-- Doors -->
					<div id="doors" class="jumbotron">
						<div class="row">
							<div class="col text-center">
								<img id="img-door-1" src="img/door-closed.png" class="img-fluid"/>
								<br />
								<button id="btn-door-1" type="button" class="btn" onclick="selectDoor(1);">Porte 1</button>
							</div>
							<div class="col text-center">
								<img id="img-door-2" src="img/door-closed.png" class="img-fluid"/>
								<br />
								<button id="btn-door-2" type="button" class="btn" onclick="selectDoor(2);">Porte 2</button>
							</div>
							<div class="col text-center">
								<img id="img-door-3" src="img/door-closed.png" class="img-fluid" />
								<br />
								<button id="btn-door-3" type="button" class="btn" onclick="selectDoor(3);">Porte 3</button>
							</div>
						</div>
						<br/>
						<!-- Rules -->
						<div id="rules" class="carousel slide" data-interval="0">
							<div class="carousel-inner">
								<div id="step-0" class="carousel-item text-center active">
									<p>Trois portes sont devant vous. Derrière l'une d'entre-elles se cache une voiture, et derrière les deux autres se cache une chèvre.</p>
									<p>Sélectionnez une porte en cliquant sur le bouton en dessous de celle-ci.</p>
								</div>
								<div id="step-1" class="carousel-item text-center">
									<p>Vous venez de sélectionner la porte <span id="step-1-selected-door" class="badge badge-info">0</span>.</p>
									<p>Le présentateur vous indique que la voiture ne se trouve pas derrière la porte <span id="step-1-wrong-door" class="badge badge-danger">0</span>.</p>
									<p>Allez-vous conserver votre choix initial, ou voulez vous changer de porte? Sélectionnez la porte que vous souhaitez ouvrir en cliquant sur le bouton en dessous de celle-ci.</p>
								</div>
								<div id="step-2" class="carousel-item text-center">
									<p id="step-2-label">0</p>
									<button id="new-run" type="button" class="btn btn-primary" onclick="startRun();">Nouvelle partie</button>
								</div>
							</div>
						</div>
					</div>
			  	</div>
			 	<div class="tab-pane fade" id="auto" role="tabpanel" aria-labelledby="auto-tab">
			 		<div class="jumbotron">
				 		<div class="container">
				 			<!-- Auto configuration -->
					 		<div id="auto-count-group" class="form-group text-center">
								<span id="auto-count-label">Nombre de simulations: <span id="auto-count-value">1</span></span>
								<input id="auto-count" class="form-control-range custom-range" type="range" min="1" max="10000" step="1" />					
							</div>
							<br/>
							<div id="auto-button-group" class="text-center">
								<button type="button" id="btn-auto" class="btn btn-success">Lancer</button>
							</div>
						</div>
			 		</div>
			 	</div>
			</div>

			<hr/>
			
			<!-- Results -->
			<h4 id="results" class="text-center">Résultats</h4>
			<div class="row">
				<div class="col text-center">
					Conserver le choix
					<br/><br/>
					<table class="w-100">
						<thead>
							<tr class="row">
								<td class="col">Parties gagnées</td>
								<td class="col">Parties (total)</td>
								<td class="col font-weight-bold">Fréquence</td>
							</tr>
						</thead>
						<tbody>
							<tr class="row">
								<td id="keep-won" class="col">0</td>
								<td id="keep-nb" class="col">0</td>
								<td id="keep-freq" class="col font-weight-bold">0</td>
							</tr>
							<tr class="row">
								<td class="col"><div id="keep-chart" class="w-100"></div></td>
							</tr>
						</tbody>
					</table>
					<br/>
				</div>
				
				<div class="col-12 col-sm-6 text-center">
					Changer de choix
					<br/><br/>
					<table class="w-100">
						<thead>
							<tr class="row">
								<td class="col">Parties gagnées</td>
								<td class="col">Parties (total)</td>
								<td class="col font-weight-bold">Fréquence</td>
							</tr>
						</thead>
						<tbody>
							<tr class="row">
								<td id="change-won" class="col">0</td>
								<td id="change-nb" class="col">0</td>
								<td id="change-freq" class="col font-weight-bold">0</td>
							</tr>
							<tr class="row">
								<td class="col"><div id="change-chart" class="w-100"></div></td>
							</tr>
						</tbody>
					</table>
					<br/>
				</div>
			</div>
		</div>
		
	</body>
</html>