<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="fr" lang="fr" dir="ltr">

	<head>
		<meta charset="UTF-8">
		
		<!-- Page title -->
		<title>Probabilités - Monty Hall</title>
		<!-- Smartphone screen dimension management -->
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		
		<!-- Libraries -->
		<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
		<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>
		<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
		<script src="https://code.highcharts.com/highcharts.js"></script>
		
		<!-- Images -->
		<link rel="preload" href="img/door-closed.png" as="image">
		<link rel="preload" href="img/door-opened-goat.png" as="image">
		<link rel="preload" href="img/door-opened-car.png" as="image">
		
		<script>
			// Session
			var session = null;
			// Step
			var step = null;
			// Selected door
			var selectedDoor = null;
			// Correct door
			var correctDoor = null;
			// Wrong door
			var wrongDoor = null;
			
			// Auto-simulation
			var autoSimulation = false;
			// Auto-simulation spped (actions per seconds)
			var autoSimulationSpeed = 1000;
			// Auto-simulation run count
			var autoSimulationIndex = 0;
			var autoSimulationNb = 1000;
			
			// Charts
			var keepChart = null;
			var changeChart = null;
			
			var decimalPlaces = 4;
			
			function displayResults(){
				$('#keep-won').text(session.keep.won);
				$('#keep-nb').text(session.keep.nb);
				$('#keep-freq').text(session.keep.freq);				
				$('#change-won').text(session.change.won);
				$('#change-nb').text(session.change.nb);
				$('#change-freq').text(session.change.freq);
				
				if(!autoSimulation || autoSimulationIndex == 2*autoSimulationNb-1 || (autoSimulationIndex+1) % (2*autoSimulationNb/10) == 0){
					keepChart.redraw();
					changeChart.redraw();
				}			
			}
			
			function startSession(){
				// Init session
				session = {
					keep: {
						won: 0,
						nb: 0,
						freq: 0
					},
					change: {
						won: 0,
						nb: 0,
						freq: 0
					},
				};
				autoSimulationIndex = 0;
				keepChart.series[0].setData([]);
				changeChart.series[0].setData([]);
				displayResults();
				startRun();
			}
			
			function startRun(){
				// Init step
				step = 0;
				// Init correct door
				correctDoor = Math.ceil(Math.random() * 3);
				wrongDoor = null;
				
				// Update UI
				if(!autoSimulation){
					// Update rules
					$('#step-0').show();
					$('#step-1').addClass('invisible');
					$('#step-2').addClass('invisible');
					// Activate buttons
					$('#btn-door-1').attr('disabled', false).removeClass('btn-info btn-danger btn-success').addClass('btn-secondary');
					$('#btn-door-2').attr('disabled', false).removeClass('btn-info btn-danger btn-success').addClass('btn-secondary');
					$('#btn-door-3').attr('disabled', false).removeClass('btn-info btn-danger btn-success').addClass('btn-secondary');
					// Reset doors
					$('#img-door-1').attr('src', 'img/door-closed.png');
					$('#img-door-2').attr('src', 'img/door-closed.png');
					$('#img-door-3').attr('src', 'img/door-closed.png');
				}
				
				if(autoSimulation){
					setTimeout(function(){
						var choice = Math.ceil(Math.random() * 3);
						handleStep0Choice(Math.ceil(Math.random() * 3));
					}, 1000 / autoSimulationSpeed);
				}
			}
			
			function selectDoor(doorIndex){
				if(step == 0){
					handleStep0Choice(doorIndex);
				}
				else if(step == 1){
					handleStep1Choice(doorIndex);
				}
			}
			
			function handleStep0Choice(doorIndex){
				// Select door
				selectedDoor = doorIndex;
				
				// Mark wrong door
				var otherDoors = [1,2,3].filter(door => door != doorIndex && door != correctDoor);
				wrongDoor = otherDoors[Math.floor(Math.random() * otherDoors.length)];
				
				// Update UI
				if(!autoSimulation){
					$('#btn-door-' + selectedDoor)
					.removeClass('btn-secondary')
					.addClass('btn-info');
					
					$('#btn-door-' + wrongDoor)
					.attr('disabled', true)
					.removeClass('btn-secondary')
					.addClass('btn-danger');
					
					// Open wrong door
					$('#img-door-' + wrongDoor).attr('src', 'img/door-opened-goat.png');
					
					// Update rules
					$('#step-1-selected-door').text(selectedDoor);
					$('#step-1-wrong-door').text(wrongDoor);
					$('#step-1').removeClass('invisible');
				}
				
				// Next step
				step = 1;
				
				if(autoSimulation){
					setTimeout(function(){
						var choice = null;
						if(autoSimulationIndex % 2 == 0){
							choice = selectedDoor;
						}
						else{
							choice = [1,2,3].filter(door => door != selectedDoor && door != wrongDoor)[0];
						}
						handleStep1Choice(choice);
					}, 1000 / autoSimulationSpeed);
				}
			};
			
			function handleStep1Choice(doorIndex){
				// Update session & rules
				if(doorIndex == selectedDoor){
					session.keep.nb += 1;
					if(doorIndex == correctDoor){
						session.keep.won += 1;
					}
					session.keep.freq = Math.round(Math.pow(10,decimalPlaces) * session.keep.won / session.keep.nb)/Math.pow(10,decimalPlaces);
					keepChart.series[0].addPoint([session.keep.nb, session.keep.freq], false, false);
				}
				else{
					session.change.nb += 1;
					if(doorIndex == correctDoor){
						session.change.won += 1;
					}
					session.change.freq = Math.round(Math.pow(10,decimalPlaces) * session.change.won / session.change.nb)/Math.pow(10,decimalPlaces);
					changeChart.series[0].addPoint([session.change.nb, session.change.freq], false, false);
				}
				
				// Update UI
				if(!autoSimulation){
					$('#btn-door-' + selectedDoor)
					.removeClass('btn-info');
					
					if(doorIndex == correctDoor)
						$('#btn-door-' + doorIndex)
						.removeClass('btn-secondary')
						.addClass('btn-success');
					else{
						$('#btn-door-' + doorIndex)
						.removeClass('btn-secondary')
						.addClass('btn-info');
						$('#btn-door-' + correctDoor)
						.removeClass('btn-secondary')
						.addClass('btn-success');
					}
					
					if(doorIndex == correctDoor){
						$('#step-2-label').text('Vous avez gagné!');
					}
					else{
						$('#step-2-label').text('Vous avez perdu...');
					}
					
					$('#step-2').removeClass('invisible');
					
					// Show doors
					$('#img-door-' + correctDoor).attr('src', 'img/door-opened-car.png');
					if(doorIndex != correctDoor)
						$('#img-door-' + selectedDoor).attr('src', 'img/door-opened-goat.png');
				}
				
				displayResults();
				
				if(autoSimulation && autoSimulationIndex < 2*autoSimulationNb-1){
					setTimeout(function(){
						autoSimulationIndex += 1;
						startRun();
					}, 1000 / autoSimulationSpeed);
				}
			};
			
			function handleAutoCheckbox(){
				if($('#auto-simulation').is(":checked")){
					$("#auto-count-group").removeClass('invisible');
					$("#auto-button-group").removeClass('invisible');
					autoSimulation = true;
				}
				else{
					$("#auto-count-group").addClass('invisible');
					$("#auto-button-group").addClass('invisible');
					autoSimulation = false;
				}
			}
			
			$(document).ready(function(){
				// Init auto checkbox
				$('#auto-simulation').change(function(){
					handleAutoCheckbox();
				})
				.prop("checked", false )
				.trigger('change');
				handleAutoCheckbox();
				
				// Init sliders
				$("#auto-count")
				.on('input', function(slideEvt) {
					var value = parseInt($(slideEvt.target).val());
					autoSimulationNb = value;
					$("#auto-count-value").text(value);
				})
				.val(autoSimulationNb)
				.trigger('input');

				// Init charts
				keepChart = Highcharts.chart('keep-chart', {
					chart: {
				        zoomType: 'x'
				    },
				    title: null,
		            xAxis: {
		            	title: {
		            		text: "Nombre d'essais"
		            	},
		            	type: 'linear'
		            },
		            yAxis: {
		            	title: {
		            		text: "Fréquence"
		            	},
		            	type: 'linear',
		            	min: 0,
		            	max: 1,
		            },
		            legend: {
      					enabled: false,
      				},
                    series: [{
			            name: null,
			            data: []
			        }]
		        });
		        changeChart = Highcharts.chart('change-chart', {
					chart: {
				        zoomType: 'x'
				    },
				    title: null,
		            xAxis: {
		            	title: {
		            		text: "Nombre d'essais"
		            	},
		            	type: 'linear'
		            },
		            yAxis: {
		            	title: null,
		            	type: 'linear',
		            	min: 0,
		            	max: 1,
		            },
                    legend: {
      					enabled: false,
      				},
      				series: [{
			            name: 'Fréquence',
			            data: []
			        }]
		        });
        
				startSession();
			});
		</script>
	</head>
	<body>
		<img src="img/door-closed.png" style="display: none"/>
		<img src="img/door-opened-goat.png" style="display: none"/>
		<img src="img/door-opened-car.png" style="display: none"/>
		
		<div class="container">
			<!-- Rules -->
			<div id="rules" class="jumbotron text-center">
				<div id="step-0">
					<h5 class="h5">Trois portes sont devant vous. Derrière l'une d'entre-elles se cache une voiture, et derrière les deux autres se cache une chèvre.</h5>
					<h5 class="h5">Sélectionnez une porte en cliquant sur le bouton en dessous de celle-ci.</h5>
				</div>
				<div id="step-1" class="invisible">
					<h5 class="h5">Vous venez de sélectionner la porte <span id="step-1-selected-door" class="badge badge-info">0</span>.</h5>
					<h5 class="h5">Le présentateur vous indique que la voiture ne se trouve pas derrière la porte <span id="step-1-wrong-door" class="badge badge-danger">0</span>.</h5>
					<h5 class="h5">Allez-vous conserver votre choix initial, ou voulez vous changer de porte? Sélectionnez la porte que vous souhaitez ouvrir en cliquant sur le bouton en dessous de celle-ci.</h5>
				</div>
				<div id="step-2" class="invisible">
					<h5 id="step-2-label" class="h5">0</h5>
					<button type="button" class="btn btn-primary" onclick="startRun();">Nouvelle partie</button>
				</div>
			</div>
			
			<!-- Doors -->
			<div id="doors" class="jumbotron row">
				<div class="col text-center">
					<img id="img-door-1" src="img/door-closed.png" class="img-fluid"/>
					<br />
					<button id="btn-door-1" type="button" class="btn" onclick="selectDoor(1);">Porte 1</button>
				</div>
				<div class="col text-center">
					<img id="img-door-2" src="img/door-closed.png" class="img-fluid"/>
					<br />
					<button id="btn-door-2" type="button" class="btn" onclick="selectDoor(2);">Porte 2</button>
				</div>
				<div class="col text-center">
					<img id="img-door-3" src="img/door-closed.png" class="img-fluid" />
					<br />
					<button id="btn-door-3" type="button" class="btn" onclick="selectDoor(3);">Porte 3</button>
				</div>
			</div>
			
			<div class="container">
				<div class="form-check custom-control custom-checkbox">
					<input id="auto-simulation" type="checkbox" class="custom-control-input"/>
					<label class="custom-control-label" for="auto-simulation">Simulation automatique</label>
				</div>
				<div id="auto-count-group" class="form-group row invisible">
					<span id="auto-count-label" class="col-4">Nombre: <span id="auto-count-value">1</span></span>
					<input id="auto-count" class="col-8 form-control-range custom-range" type="range" min="1" max="10000" step="1" />					
				</div>
				<div id="auto-button-group" class="form-group text-center invisible">
					<button type="button" class="btn btn-primary" onclick="startSession();">Lancer</button>
				</div>
			</div>
			
			<!-- Results -->
			<h4 class="text-center">Résultats</h4>
			<div class="row">
				<div class="col text-center">
					Conserver le choix
					<br/><br/>
					<table class="w-100">
						<thead>
							<tr class="row">
								<td class="col">Parties gagnées</td>
								<td class="col">Parties (total)</td>
								<td class="col font-weight-bold">Fréquence</td>
							</tr>
						</thead>
						<tbody>
							<tr class="row">
								<td id="keep-won" class="col">0</td>
								<td id="keep-nb" class="col">0</td>
								<td id="keep-freq" class="col font-weight-bold">0</td>
							</tr>
							<tr class="row">
								<td class="col"><div id="keep-chart" class="w-100"></div></td>
							</tr>
						</tbody>
					</table>
					<br/>
				</div>
				
				<div class="col-12 col-sm-6 text-center">
					Changer de choix
					<br/><br/>
					<table class="w-100">
						<thead>
							<tr class="row">
								<td class="col">Parties gagnées</td>
								<td class="col">Parties (total)</td>
								<td class="col font-weight-bold">Fréquence</td>
							</tr>
						</thead>
						<tbody>
							<tr class="row">
								<td id="change-won" class="col">0</td>
								<td id="change-nb" class="col">0</td>
								<td id="change-freq" class="col font-weight-bold">0</td>
							</tr>
							<tr class="row">
								<td class="col"><div id="change-chart" class="w-100"></div></td>
							</tr>
						</tbody>
					</table>
					<br/>
				</div>
			</div>
		</div>
		
	</body>
</html>